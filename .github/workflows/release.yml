name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Servers
          - os: ubuntu-latest
            type: server
            artifact: mobium-server-linux-x86_64
          # Clients
          - os: ubuntu-latest
            type: client
            artifact: Mobium-linux-x86_64
          - os: windows-latest
            type: client
            artifact: Mobium-windows-x86_64
          - os: macos-latest
            type: client
            artifact: Mobium-macos-aarch64
          - os: macos-13
            type: client
            artifact: Mobium-macos-x86_64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ matrix.type }}-${{ hashFiles('**/Cargo.lock') }}

      # --- Server Build ---
      - name: Build server
        if: matrix.type == 'server'
        run: cargo build --release -p mobium-server

      - name: Package server
        if: matrix.type == 'server'
        run: |
          mkdir -p dist
          cp target/release/mobium-server dist/${{ matrix.artifact }}
          cp .env.example dist/
          cd dist && tar czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }} .env.example

      # --- Client Build ---
      - uses: actions/setup-node@v4
        if: matrix.type == 'client'
        with:
          node-version: '22'

      - name: Install Linux deps
        if: matrix.type == 'client' && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Install Tauri CLI
        if: matrix.type == 'client'
        run: cargo install tauri-cli --version "^2" --locked

      - name: Install client deps
        if: matrix.type == 'client'
        working-directory: client
        run: npm ci

      - name: Build client
        if: matrix.type == 'client'
        working-directory: client
        run: cargo tauri build

      - name: Collect client artifacts (Linux)
        if: matrix.type == 'client' && runner.os == 'Linux'
        run: |
          mkdir -p dist
          find . -path "*/bundle/deb/*.deb" -exec cp {} dist/${{ matrix.artifact }}.deb \;
          find . -path "*/bundle/appimage/*.AppImage" -exec cp {} dist/${{ matrix.artifact }}.AppImage \; || true

      - name: Collect client artifacts (Windows)
        if: matrix.type == 'client' && runner.os == 'Windows'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist
          $msi = Get-ChildItem -Recurse -Filter "*.msi" | Where-Object { $_.FullName -match "bundle" } | Select-Object -First 1
          if ($msi) { Copy-Item $msi.FullName -Destination "dist/${{ matrix.artifact }}.msi" }
          $exe = Get-ChildItem -Recurse -Filter "*.exe" | Where-Object { $_.FullName -match "nsis" } | Select-Object -First 1
          if ($exe) { Copy-Item $exe.FullName -Destination "dist/${{ matrix.artifact }}-setup.exe" }

      - name: Collect client artifacts (macOS)
        if: matrix.type == 'client' && runner.os == 'macOS'
        run: |
          mkdir -p dist
          find . -path "*/bundle/dmg/*.dmg" -exec cp {} dist/${{ matrix.artifact }}.dmg \;

      # --- Upload to Release ---
      - name: List artifacts
        shell: bash
        run: ls -lhR dist/ 2>/dev/null || echo "No artifacts"

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
